# Dockerfile for Xray Server with Statistical Obfuscation
FROM golang:1.25-alpine AS builder

# Install build dependencies
RUN apk add --no-cache git build-base

# Set working directory
WORKDIR /build

# Copy source code
COPY . .

# Build Xray with obfuscation module
RUN CGO_ENABLED=0 go build -o xray -trimpath -buildvcs=false \
    -ldflags="-s -w -buildid=" \
    -v ./main

# Runtime stage
FROM alpine:latest

# Install runtime dependencies
RUN apk add --no-cache ca-certificates tzdata iptables

# Copy binary
COPY --from=builder /build/xray /usr/local/bin/xray

# Create directories
RUN mkdir -p /etc/xray /usr/local/share/xray /var/log/xray

# Download geodata files
ADD https://github.com/v2fly/geoip/releases/latest/download/geoip.dat /usr/local/share/xray/
ADD https://github.com/v2fly/domain-list-community/releases/latest/download/dlc.dat /usr/local/share/xray/geosite.dat

WORKDIR /etc/xray

EXPOSE 443

ENTRYPOINT ["/usr/local/bin/xray"]
CMD ["run", "-c", "/etc/xray/config.json"]
